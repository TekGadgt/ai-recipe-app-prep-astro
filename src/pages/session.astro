---
import Layout from "../layouts/Layout.astro";
import IngredientManager from "../components/IngredientManager.astro";
import RecipeManager from "../components/RecipeManager.astro";
import SessionControls from "../components/SessionControls.astro";
---

<Layout title="Pantry Party - Session">
  <!-- Session Header -->
  <div class="card mb-4">
    <div class="card-content">
      <div
        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"
      >
        <div>
          <h1
            style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;"
          >
            Cooking Session
          </h1>
          <div
            id="session-details"
            style="color: #6b7280; font-size: 0.875rem;"
          >
            Loading session...
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div
            id="participant-count"
            style="font-size: 0.875rem; color: #6b7280;"
          >
            <!-- Participant count will be shown here -->
          </div>
          <button id="share-session" class="btn btn-primary btn-sm">
            Share Session
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Session Content -->
  <div class="grid">
    <!-- Left Column: Ingredients & Context -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
      <!-- Context Input -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Cooking Context</h2>
          <p class="card-description">
            Add context to help generate better recipes (optional)
          </p>
        </div>
        <div class="card-content">
          <form id="context-form">
            <div class="form-group">
              <textarea
                id="cooking-context"
                class="form-textarea"
                placeholder="e.g., We're grilling outdoors, Making dessert, Quick lunch ideas, Vegetarian only..."
                rows="3"
                maxlength="500"></textarea>
              <div
                style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;"
              >
                <div style="font-size: 0.75rem; color: #6b7280;">
                  <span id="context-char-count">0</span>/500 characters
                </div>
                <button type="submit" class="btn btn-secondary btn-sm">
                  Update Context
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Ingredient Manager -->
      <IngredientManager />
    </div>

    <!-- Right Column: Recipes -->
    <div>
      <RecipeManager />
    </div>
  </div>

  <!-- Session Controls (Host Only) -->
  <SessionControls />

  <!-- Share Modal -->
  <div id="share-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Share Session</h3>
        <button class="modal-close" onclick="closeShareModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Session Code</label>
          <div style="display: flex; gap: 0.5rem;">
            <input
              type="text"
              id="session-code-display"
              class="form-input"
              readonly
              style="font-family: monospace; font-size: 1.25rem; text-align: center; letter-spacing: 0.1em;"
            />
            <button class="btn btn-secondary" onclick="copySessionCode()">
              Copy
            </button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Share Link</label>
          <div style="display: flex; gap: 0.5rem;">
            <input
              type="text"
              id="session-link-display"
              class="form-input"
              readonly
            />
            <button class="btn btn-secondary" onclick="copySessionLink()">
              Copy
            </button>
          </div>
        </div>
        <div
          style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 1rem; margin-top: 1rem;"
        >
          <h4 style="font-weight: 500; margin-bottom: 0.5rem;">How to Join:</h4>
          <ol style="margin-left: 1.5rem; color: #0f172a;">
            <li>Share the session code or link with friends</li>
            <li>They can enter the code on the homepage</li>
            <li>Or click the shared link directly</li>
            <li>They'll need their own OpenAI API key to generate recipes</li>
          </ol>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeShareModal()"
          >Close</button
        >
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="error-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Error</h3>
        <button class="modal-close" onclick="closeErrorModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="error-message"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeErrorModal()"
          >Close</button
        >
      </div>
    </div>
  </div>
</Layout>

<style>
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 1.5rem 0;
    border-bottom: 1px solid #e5e7eb;
  }

  .modal-header h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 0 1.5rem 1.5rem;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }

  @media (max-width: 1024px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script type="module">
  import {
    UserStorage,
    SessionStorage,
    ContextStorage,
    IngredientsStorage,
    BlacklistStorage,
    RecipeStorage,
  } from "/scripts/storage.js";
  import { WebSocketManager, SessionSyncManager } from "/scripts/websocket.js";

  let currentSession = null;
  let currentUser = null;
  let wsManager = null;
  let syncManager = null;
  let isHost = false;

  // Show error modal
  window.showError = function (message) {
    document.getElementById("error-message").textContent = message;
    document.getElementById("error-modal").style.display = "flex";
  };

  // Close error modal
  window.closeErrorModal = function () {
    document.getElementById("error-modal").style.display = "none";
  };

  // Share session modal functions
  window.closeShareModal = function () {
    document.getElementById("share-modal").style.display = "none";
  };

  window.copySessionCode = function () {
    const codeInput = document.getElementById("session-code-display");
    codeInput.select();
    document.execCommand("copy");

    // Show feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = "Copied!";
    setTimeout(() => {
      button.textContent = originalText;
    }, 2000);
  };

  window.copySessionLink = function () {
    const linkInput = document.getElementById("session-link-display");
    linkInput.select();
    document.execCommand("copy");

    // Show feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = "Copied!";
    setTimeout(() => {
      button.textContent = originalText;
    }, 2000);
  };

  // Initialize session from URL parameters
  function initializeSession() {
    const urlParams = new URLSearchParams(window.location.search);
    const sessionCode = urlParams.get("code");
    isHost = urlParams.get("host") === "true";
    const isParticipant = urlParams.has("participant");
    const isContinuing = urlParams.get("continue") === "true";

    // Global sync state to prevent race conditions
    window.syncState = {
      syncing: false,
      pendingOperations: new Set(),
    };

    if (!sessionCode) {
      showError("No session code provided");
      setTimeout(() => (window.location.href = "/"), 2000);
      return;
    }

    currentUser = UserStorage.get();
    if (!currentUser) {
      showError("User not found. Please start from the homepage.");
      setTimeout(() => (window.location.href = "/"), 2000);
      return;
    }

    // Initialize WebSocket connection
    initializeWebSocket();

    if (isHost || isContinuing) {
      // Load existing session from localStorage
      currentSession = SessionStorage.get();
      if (!currentSession || currentSession.id !== sessionCode) {
        showError("Session not found or expired");
        setTimeout(() => (window.location.href = "/"), 2000);
        return;
      }

      // Create WebSocket session as host
      wsManager.createSession(sessionCode, currentUser.id, currentUser.name);
    } else {
      // Join existing WebSocket session as participant
      wsManager.joinSession(sessionCode, currentUser.id, currentUser.name);
    }

    updateSessionDisplay();
    loadContext();
  }

  // Initialize WebSocket connection and sync manager
  function initializeWebSocket() {
    wsManager = new WebSocketManager();

    const storageProxy = {
      ...SessionStorage,
      ...ContextStorage,
      clearSession: () => SessionStorage.clear(),
      setSessionInfo: (id, hostId, hostName) => {
        SessionStorage.update({ id, hostId, hostName });
      },
      // Add ingredient storage methods
      addIngredient: (name, addedBy, id = null) => {
        if (id) {
          // When ID is provided (from server), use it directly
          return IngredientsStorage.addWithId({ name, addedBy, id });
        } else {
          // Normal local addition
          return IngredientsStorage.add({ name, addedBy });
        }
      },
      removeIngredient: (ingredientId) =>
        IngredientsStorage.remove(ingredientId),
      getIngredients: () => IngredientsStorage.get(),
      clearIngredients: () => IngredientsStorage.clear(),
      // Add blacklist storage methods
      addToBlacklist: (ingredient) => BlacklistStorage.add(ingredient),
      removeFromBlacklist: (ingredient) => BlacklistStorage.remove(ingredient),
      getBlacklist: () => BlacklistStorage.get(),
      clearBlacklist: () => BlacklistStorage.clear(),
      // Add recipe storage methods
      addRecipe: (recipe, preserveId = false) => {
        if (preserveId && recipe.id) {
          return RecipeStorage.addWithId(recipe);
        } else {
          return RecipeStorage.add(recipe);
        }
      },
      removeRecipe: (recipeId) => RecipeStorage.remove(recipeId),
      getRecipes: () => RecipeStorage.get(),
      clearRecipes: () => RecipeStorage.clear(),
      setRecipes: (recipes) => RecipeStorage.set(recipes),
    };

    syncManager = new SessionSyncManager(wsManager, storageProxy);

    // Setup WebSocket event handlers
    wsManager.on("connection:open", handleWebSocketOpen);
    wsManager.on("connection:close", handleWebSocketClose);
    wsManager.on("connection:error", handleWebSocketError);
    wsManager.on("session:created", handleSessionCreated);
    wsManager.on("session:joined", handleSessionJoined);
    wsManager.on("session:error", handleSessionError);
  }

  // WebSocket event handlers
  function handleWebSocketOpen() {
    console.log("WebSocket connected");
    updateConnectionStatus(true);
  }

  function handleWebSocketClose() {
    console.log("WebSocket disconnected");
    updateConnectionStatus(false);
  }

  function handleWebSocketError(error) {
    console.error("WebSocket error:", error);
    showError("Connection error. Please refresh the page.");
  }

  function handleSessionCreated(message) {
    currentSession = message.session;
    updateSessionDisplay();
  }

  function handleSessionJoined(message) {
    currentSession = message.session;
    updateSessionDisplay();
    loadContext();
  }

  function handleSessionError(message) {
    showError(message.message);
    if (
      message.message.includes("not found") ||
      message.message.includes("expired")
    ) {
      setTimeout(() => (window.location.href = "/"), 3000);
    }
  }

  // Update connection status indicator
  function updateConnectionStatus(connected) {
    const sessionDetails = document.getElementById("session-details");
    if (!sessionDetails) return;

    const statusIndicator = connected
      ? '<span style="color: #10b981;">● Connected</span>'
      : '<span style="color: #ef4444;">● Disconnected</span>';

    if (currentSession) {
      sessionDetails.innerHTML = `
        ${statusIndicator} • 
        <strong>Code:</strong> ${currentSession.id} • 
        <strong>Host:</strong> ${currentSession.hostName} • 
        <strong>Created:</strong> ${new Date(currentSession.createdAt).toLocaleTimeString()}
      `;
    } else {
      sessionDetails.innerHTML = statusIndicator;
    }
  }

  // Update session display
  function updateSessionDisplay() {
    if (!currentSession) return;

    const connected = wsManager && wsManager.isConnected;
    const statusIndicator = connected
      ? '<span style="color: #10b981;">● Connected</span>'
      : '<span style="color: #ef4444;">● Disconnected</span>';

    const sessionDetails = document.getElementById("session-details");
    const participantCount = document.getElementById("participant-count");

    sessionDetails.innerHTML = `
      ${statusIndicator} • 
      <strong>Code:</strong> ${currentSession.id} • 
      <strong>Host:</strong> ${currentSession.hostName} • 
      <strong>Created:</strong> ${new Date(currentSession.createdAt).toLocaleTimeString()}
    `;

    participantCount.textContent = `${currentSession.participants?.length || 1} participant(s)`;

    // Set up share modal
    document.getElementById("session-code-display").value = currentSession.id;
    document.getElementById("session-link-display").value =
      `${window.location.origin}/session?code=${currentSession.id}`;
  }

  // Load and display context
  function loadContext() {
    const context = ContextStorage.get();
    const contextTextarea = document.getElementById("cooking-context");
    const charCount = document.getElementById("context-char-count");

    contextTextarea.value = context;
    charCount.textContent = context.length;
  }

  // Context form handler
  document.getElementById("context-form").addEventListener("submit", (e) => {
    e.preventDefault();
    const context = document.getElementById("cooking-context").value.trim();
    ContextStorage.set(context);

    // Broadcast context change via WebSocket
    if (wsManager && wsManager.isConnected) {
      wsManager.updateContext(context);
    }

    // Show feedback
    const button = e.target.querySelector("button");
    const originalText = button.textContent;
    button.textContent = "Saved!";
    button.classList.remove("btn-secondary");
    button.classList.add("btn-success");

    setTimeout(() => {
      button.textContent = originalText;
      button.classList.remove("btn-success");
      button.classList.add("btn-secondary");
    }, 2000);
  });

  // Context character count
  document.getElementById("cooking-context").addEventListener("input", (e) => {
    const charCount = document.getElementById("context-char-count");
    charCount.textContent = e.target.value.length;
  });

  // Share session button
  document.getElementById("share-session").addEventListener("click", () => {
    document.getElementById("share-modal").style.display = "flex";
  });

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", initializeSession);

  // Handle page visibility change to update session activity
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden && currentSession) {
      SessionStorage.update({ lastActivity: Date.now() });
    }
  });

  // Global functions for components and refresh utilities
  window.getCurrentSession = () => currentSession;
  window.getCurrentUser = () => currentUser;
  window.getWebSocketManager = () => wsManager;
  window.getSyncManager = () => syncManager;
  window.isSessionHost = () => isHost;

  // UI refresh functions called by sync manager
  window.updateParticipantsList = (participants) => {
    // Update the session participants data
    if (currentSession) {
      currentSession.participants = participants;
    }

    // Update participant count in header
    const participantCount = document.getElementById("participant-count");
    if (participantCount) {
      participantCount.textContent = `${participants.length} participant(s)`;
    }

    // Update participant list in session controls if function exists
    if (typeof window.loadParticipants === "function") {
      window.loadParticipants();
    }
  };

  window.updateContextDisplay = () => {
    loadContext();
  };

  window.updateHostControls = (isHost, allowRecipeGeneration) => {
    // This will be handled by SessionControls component
    if (typeof window.refreshSessionControls === "function") {
      window.refreshSessionControls(isHost, allowRecipeGeneration);
    }
  };
</script>
